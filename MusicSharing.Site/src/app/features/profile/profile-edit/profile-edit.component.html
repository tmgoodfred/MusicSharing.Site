<div class="container mx-auto py-8">
  <div class="max-w-2xl mx-auto bg-card-background rounded-lg shadow-lg p-6 md:p-8">
    <h1 class="text-2xl font-bold mb-6">Edit Profile</h1>

    <div *ngIf="error" class="bg-red-100 dark:bg-red-900 border border-red-400 text-red-700 dark:text-red-200 px-4 py-3 rounded mb-6">
      {{ error }}
    </div>

    <form [formGroup]="profileForm" (ngSubmit)="onSubmit()">
      <!-- Profile picture -->
      <div class="mb-6">
        <label class="block mb-2 font-medium">Profile Picture</label>
        <div class="flex items-center space-x-4">
          <div class="w-16 h-16 rounded-full bg-gray-200 dark:bg-gray-700 overflow-hidden flex items-center justify-center">
            <!-- Show preview if chosen; otherwise show current profile picture if available -->
            <img *ngIf="profilePreview || currentUser?.profilePicturePath"
                 [src]="profilePreview || ('https://music-sharing.online/api/user/' + currentUser?.id + '/profile-picture')"
                 class="w-full h-full object-cover"
                 alt="Profile picture">
            <div *ngIf="!(profilePreview || currentUser?.profilePicturePath)" class="text-gray-500">
              <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10 3a7 7 0 100 14 7 7 0 000-14zM8 9a2 2 0 114 0 2 2 0 01-4 0z" />
              </svg>
            </div>
          </div>
          <label class="btn-secondary cursor-pointer">
            <input type="file" accept="image/*" class="hidden" (change)="onProfilePictureSelected($event)">
            Choose Image
          </label>
        </div>
      </div>

      <!-- Cropper modal -->
      <div *ngIf="showCropper" class="modal-overlay" (click)="cancelCrop()">
        <div class="modal" (click)="$event.stopPropagation()" role="dialog" aria-modal="true" aria-labelledby="cropTitle">
          <div class="flex items-center justify-between mb-3">
            <h3 id="cropTitle" class="text-lg font-semibold">Crop Profile Picture</h3>
            <button (click)="cancelCrop()" class="p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-800" aria-label="Close">âœ•</button>
          </div>

          <image-cropper [imageChangedEvent]="imageChangedEvent"
                         [maintainAspectRatio]="true"
                         [aspectRatio]="1"
                         [roundCropper]="true"
                         [resizeToWidth]="512"
                         format="png"
                         (imageCropped)="imageCropped($event)"
                         (loadImageFailed)="loadImageFailed()">
          </image-cropper>

          <div class="flex justify-end space-x-2 mt-3">
            <button type="button" class="btn-secondary" (click)="cancelCrop()">Cancel</button>
            <button type="button" class="btn-primary" (click)="confirmCrop()">Use Photo</button>
          </div>
        </div>
      </div>

      <!-- Username -->
      <div class="mb-6">
        <label for="username" class="block mb-2 font-medium">Username</label>
        <input type="text"
               id="username"
               formControlName="username"
               class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-primary"
               [ngClass]="{'border-red-500': profileForm.get('username')?.invalid && profileForm.get('username')?.touched}">
        <div *ngIf="profileForm.get('username')?.invalid && profileForm.get('username')?.touched" class="text-red-500 mt-1">
          <span *ngIf="profileForm.get('username')?.errors?.['required']">Username is required</span>
          <span *ngIf="profileForm.get('username')?.errors?.['minlength']">Username must be at least 3 characters</span>
        </div>
      </div>

      <!-- Email -->
      <div class="mb-6">
        <label for="email" class="block mb-2 font-medium">Email</label>
        <input type="email"
               id="email"
               formControlName="email"
               class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-primary"
               [ngClass]="{'border-red-500': profileForm.get('email')?.invalid && profileForm.get('email')?.touched}">
        <div *ngIf="profileForm.get('email')?.invalid && profileForm.get('email')?.touched" class="text-red-500 mt-1">
          <span *ngIf="profileForm.get('email')?.errors?.['required']">Email is required</span>
          <span *ngIf="profileForm.get('email')?.errors?.['email']">Enter a valid email address</span>
        </div>
      </div>

      <!-- Toggle password section -->
      <div class="mb-2">
        <button type="button" class="btn-secondary" (click)="toggleChangePassword()">
          {{ changePassword ? 'Cancel Password Change' : 'Change Password' }}
        </button>
      </div>

      <!-- Password fields (only visible if toggled) -->
      <div *ngIf="changePassword" class="border-t border-gray-200 dark:border-gray-700 my-4 pt-4">
        <div class="mb-2 text-sm text-gray-600 dark:text-gray-400">
          Password must be at least 8 characters and include uppercase, lowercase, and a number or symbol.
        </div>
        <div class="mb-4">
          <label for="newPassword" class="block mb-2 font-medium">New Password</label>
          <input type="password" id="newPassword" formControlName="newPassword" class="w-full px-3 py-2 border rounded"
                 [ngClass]="{'border-red-500': profileForm.get('newPassword')?.invalid && profileForm.get('newPassword')?.touched}">
          <div *ngIf="profileForm.get('newPassword')?.invalid && profileForm.get('newPassword')?.touched" class="text-red-500 mt-1">
            <span *ngIf="profileForm.get('newPassword')?.errors?.['required']">New password is required</span>
            <span *ngIf="profileForm.get('newPassword')?.errors?.['minlength']">Password must be at least 8 characters</span>
          </div>
        </div>

        <div class="mb-6">
          <label for="confirmPassword" class="block mb-2 font-medium">Confirm New Password</label>
          <input type="password" id="confirmPassword" formControlName="confirmPassword" class="w-full px-3 py-2 border rounded"
                 [ngClass]="{'border-red-500': profileForm.get('confirmPassword')?.invalid && profileForm.get('confirmPassword')?.touched}">
          <div *ngIf="profileForm.get('confirmPassword')?.invalid && profileForm.get('confirmPassword')?.touched" class="text-red-500 mt-1">
            <span *ngIf="profileForm.get('confirmPassword')?.errors?.['required']">Please confirm your new password</span>
            <span *ngIf="profileForm.get('confirmPassword')?.errors?.['mismatch']">Passwords do not match</span>
          </div>
        </div>
      </div>

      <div class="flex justify-end space-x-4">
        <button type="button"
                routerLink="/profile"
                class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition">
          Cancel
        </button>

        <button type="submit"
                class="btn-primary flex items-center"
                [disabled]="profileForm.invalid || isSubmitting">
          <ng-container *ngIf="isSubmitting">
            <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </ng-container>
          Save Changes
        </button>
      </div>
    </form>
  </div>
</div>
